name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy with Kamal
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2.3'
        bundler-cache: true

    - name: Install Kamal
      run: gem install kamal

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Create Kamal secrets
      run: |
        mkdir -p .kamal
        echo "RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}" >> .kamal/secrets
        echo "SECRET_KEY_BASE=${{ secrets.SECRET_KEY_BASE }}" >> .kamal/secrets
        echo "KAMAL_REGISTRY_USERNAME=${{ secrets.KAMAL_REGISTRY_USERNAME }}" >> .kamal/secrets
        echo "KAMAL_REGISTRY_PASSWORD=${{ secrets.KAMAL_REGISTRY_PASSWORD }}" >> .kamal/secrets
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .kamal/secrets

    # ã€å¤‰æ›´ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œã¨ãƒ­ã‚°ä¿å­˜
    - name: Deploy with Kamal
      run: |
        # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œã—ãªãŒã‚‰ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        kamal deploy 2>&1 | tee deploy.log
        # çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜
        echo $? > deploy_exit_code.txt

    # ã€è¿½åŠ ã€‘ãƒ­ã‚°æ•´å½¢ãƒ»è‰²ä»˜ãè¡¨ç¤º
    - name: Format and Display Deploy Logs
      if: always()  # æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšå®Ÿè¡Œ
      run: |
        # è‰²å®šç¾©ï¼ˆANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼‰
        RED='\033[0;31m'
        YELLOW='\033[0;33m'
        BLUE='\033[0;34m'
        GREEN='\033[0;32m'
        CYAN='\033[0;36m'
        BOLD='\033[1m'
        NC='\033[0m' # No Color
        
        echo "Processing deployment logs..."
        
        # æ•´å½¢æ¸ˆã¿ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        {
          echo -e "${BOLD}${BLUE}===== Deployment Log Summary =====${NC}"
          echo ""
          
          # ãƒ•ã‚§ãƒ¼ã‚ºã®æ¦‚è¦ã‚’è¡¨å½¢å¼ã§è¡¨ç¤º
          echo -e "${BOLD}${CYAN}Deployment Phases:${NC}"
          echo "----------------------------------------"
          
          # Running/Finished ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
          grep -E "(Running|Finished)" deploy.log | while IFS= read -r line; do
            if echo "$line" | grep -q "ERROR\|FAIL\|Fatal"; then
              echo -e "${RED}$line${NC}"
            elif echo "$line" | grep -q "Finished"; then
              echo -e "${GREEN}$line${NC}"
            else
              echo -e "${CYAN}$line${NC}"
            fi
          done
          
          echo ""
          echo -e "${BOLD}${BLUE}===== Error Summary =====${NC}"
          echo ""
          
          # ã‚¨ãƒ©ãƒ¼/å¤±æ•—ç³»ã®ãƒ­ã‚°ã‚’å¼·èª¿è¡¨ç¤º
          if grep -iE "(error|fail|fatal|exception|abort|critical)" deploy.log > /dev/null; then
            echo -e "${RED}Errors/Failures detected:${NC}"
            echo "----------------------------------------"
            
            # ã‚¨ãƒ©ãƒ¼å‰å¾Œã®æ–‡è„ˆã‚’è¡¨ç¤ºï¼ˆå‰2è¡Œã€å¾Œ2è¡Œï¼‰
            grep -B 2 -A 2 -iE "(error|fail|fatal|exception|abort|critical)" deploy.log | while IFS= read -r line; do
              if echo "$line" | grep -iE "(error|fail|fatal|exception|abort|critical)"; then
                echo -e "${RED}${BOLD}$line${NC}"
              elif [ "$line" != "--" ]; then
                echo -e "${YELLOW}$line${NC}"
              fi
            done
          else
            echo -e "${GREEN}No errors detected in deployment.${NC}"
          fi
          
          echo ""
          echo -e "${BOLD}${BLUE}===== Full Log (first 500 lines) =====${NC}"
          echo ""
          
          # ãƒ•ãƒ«ãƒ­ã‚°ã®æœ€åˆã®500è¡Œã‚’è¡¨ç¤ºï¼ˆè‰²ä»˜ãï¼‰
          head -n 500 deploy.log | while IFS= read -r line; do
            if echo "$line" | grep -iE "(error|fail|fatal|exception|abort|critical)"; then
              echo -e "${RED}$line${NC}"
            elif echo "$line" | grep -E "(Running|Starting|Building|Pushing|Deploying)"; then
              echo -e "${CYAN}$line${NC}"
            elif echo "$line" | grep -E "(Finished|Success|Complete|Done)"; then
              echo -e "${GREEN}$line${NC}"
            elif echo "$line" | grep -E "^(==|--|\#\#)"; then
              echo -e "${BLUE}$line${NC}"
            else
              echo "$line"
            fi
          done
          
          # 500è¡Œã‚’è¶…ãˆã‚‹å ´åˆã¯çœç•¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if [ $(wc -l < deploy.log) -gt 500 ]; then
            echo ""
            echo -e "${YELLOW}... (log truncated, showing first 500 lines of $(wc -l < deploy.log) total)${NC}"
          fi
        } | tee skimmed.log
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        EXIT_CODE=$(cat deploy_exit_code.txt)
        if [ "$EXIT_CODE" -eq 0 ]; then
          echo ""
          echo -e "${GREEN}${BOLD}âœ… Deployment completed successfully!${NC}"
        else
          echo ""
          echo -e "${RED}${BOLD}âŒ Deployment failed with exit code: $EXIT_CODE${NC}"
        fi

    # ã€è¿½åŠ ã€‘GitHub Actions Summary ã«å‡ºåŠ›
    - name: Write to GitHub Step Summary
      if: always()
      run: |
        # GitHub Actions Summary ã«æ•´å½¢æ¸ˆã¿ãƒ­ã‚°ã‚’å‡ºåŠ›
        {
          echo "## ğŸ“¦ Deployment Log Summary"
          echo ""
          echo "### Deployment Status"
          
          EXIT_CODE=$(cat deploy_exit_code.txt || echo "1")
          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "âœ… **Deployment completed successfully!**"
          else
            echo "âŒ **Deployment failed with exit code: $EXIT_CODE**"
          fi
          
          echo ""
          echo "### Deployment Phases"
          echo '```'
          grep -E "(Running|Finished)" deploy.log | head -20 || echo "No phase information found"
          echo '```'
          
          echo ""
          echo "### Error Summary"
          if grep -iE "(error|fail|fatal|exception|abort|critical)" deploy.log > /dev/null; then
            echo "âš ï¸ **Errors detected during deployment:**"
            echo '```'
            grep -B 1 -A 1 -iE "(error|fail|fatal|exception|abort|critical)" deploy.log | head -50
            echo '```'
          else
            echo "âœ… **No errors detected**"
          fi
          
          echo ""
          echo "### Log Preview (first 100 lines)"
          echo '```'
          head -n 100 deploy.log
          echo '```'
          
          if [ $(wc -l < deploy.log) -gt 100 ]; then
            echo ""
            echo "_Full logs available in artifacts ($(wc -l < deploy.log) lines total)_"
          fi
        } >> $GITHUB_STEP_SUMMARY

    # ã€è¿½åŠ ã€‘ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ãƒ­ã‚°ã‚’ä¿å­˜
    - name: Upload deployment logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: deployment-logs
        path: |
          deploy.log
          skimmed.log
        retention-days: 30